# literumilo 語根分解問題の詳細分析と修正方法

## 調査実施日
2025-10-15

## 発見された問題の一覧

| No | 単語 | 現在の結果 | 期待される結果 | 問題の種類 |
|----|------|-----------|---------------|-----------|
| 1 | socialisto | ❌ 無効 | social.ist.o | コード修正が必要 |
| 2 | konsentita | ❌ 無効 | konsent.it.a | 辞書データ修正が必要 |
| 3 | Venontjaraj | ❌ 無効 | ven.ont.jar.aj | アルゴリズム拡張が必要 |
| 4 | venontjaran | ❌ 無効 | ven.ont.jar.an | アルゴリズム拡張が必要 |
| 5 | interkonsentite | ❌ 無効 | inter.konsent.it.e | 辞書データ修正が必要 (#2と同根) |
| 6 | Esperanto-Kongreso | ⚠️ Esperant.oK.on.gres.o | Esperant.o.Kongres.o | 大文字保持ロジックの問題 |

---

## Problem 1: socialisto (社会主義者)

### 問題の詳細

**現在の動作:**
- `socialisto` → 無効 (分解失敗)

**期待される動作:**
- `socialisto` → `social.ist.o` (✓有効)

### 根本原因

**ファイル:** `literumilo/literumilo_suffix.py` (行386-397)

```python
def check_ist(index, morpheme_list):
    """Check suffix -ist, meaning 'a professional, supporter of a idea, doctrine, etc.'.
    Eg. Esperant-ist-o (Esperantisto)
    For a description of parameters see check_acx().
    """
    if index == 0: return False
    previous_entry = morpheme_list.get(index - 1)
    if previous_entry:
        pos = previous_entry.part_of_speech
        meaning = previous_entry.meaning
        if  pos <= POS.Verb and (not is_person(meaning)): return True  # ← 問題の行
    return False
```

**問題点:**
- 条件: `pos <= POS.Verb` は「名詞 (1) または動詞 (3) またはそれ以下」のみを許可
- `social` は形容詞 (POS.Adjective = 4)
- 4 <= 3 は False となり、check_ist が失敗

**実際のエスペラント:**
- 形容詞からも `-ist` で人を作ることができる:
  - `social` → `socialisto` (社会主義者)
  - `ideal` → `idealisto` (理想主義者)
  - `material` → `materialisto` (唯物論者)
  - `komunist` → `komunisto` (共産主義者)

### 修正方法

#### オプション1: コード修正 (推奨)

**ファイル:** `literumilo/literumilo_suffix.py` (行396)

**修正前:**
```python
if  pos <= POS.Verb and (not is_person(meaning)): return True
```

**修正後:**
```python
if  pos <= POS.Adjective and (not is_person(meaning)): return True
```

**理由:**
- 形容詞 (POS.Adjective = 4) も許可する
- これにより、名詞・動詞・形容詞すべてから `-ist` を作成可能

#### オプション2: 辞書データ修正

**ファイル:** `literumilo/data/vortaro.tsv`

```tsv
# 追加行
socialist	SUBST	PERSONO	N	N	KF	NLM	3	R
```

**利点:**
- 即座に動作
- コード変更不要

**欠点:**
- 他の同様の単語（idealisto, materialisto など）も個別に追加が必要
- 辞書が肥大化

---

## Problem 2 & 4: konsentita / interkonsentite (同意された)

### 問題の詳細

**現在の動作:**
- `konsentita` → 無効 (分解失敗)
- `interkonsentite` → 無効 (分解失敗)

**期待される動作:**
- `konsentita` → `konsent.it.a` (✓有効)
- `interkonsentite` → `inter.konsent.it.e` (✓有効)

### 根本原因

**ファイル:** `literumilo/data/vortaro.tsv` (行数不明)

```tsv
konsent	VERBO	N	N	N	KF	NLM	0	R
        ^^^^       ^
        動詞      他動性=自動詞(N)
```

**問題点:**
- `konsent` の他動性フィールドが `N` (自動詞=Intransitive)
- 受動分詞 `-it-` は他動詞 (Transitive) にのみ使用可能
- そのため `konsent.it.a` が拒否される

**実際のエスペラント:**
- `konsenti` は他動詞として使用可能:
  - `Mi konsentas vian proponon.` (私はあなたの提案に同意する)
  - `La propono estas konsentita.` (提案は同意された)

### 修正方法

#### 辞書データ修正 (必須)

**ファイル:** `literumilo/data/vortaro.tsv`

**修正前:**
```tsv
konsent	VERBO	N	N	N	KF	NLM	0	R
```

**修正後:**
```tsv
konsent	VERBO	N	X	N	KF	NLM	0	R
```

**変更点:**
- 他動性フィールド: `N` (自動詞) → `X` (自動詞と他動詞の両方)

**理由:**
- `X` (両用) にすることで、自動詞用法も他動詞用法も許可
- これにより受動分詞 `-it-` が使用可能になる

---

## Problem 3: Venontjaraj / venontjaran (来たる年々の)

### 問題の詳細

**現在の動作:**
- `Venontjaraj` → 無効 (分解失敗)
- `venontjaran` → 無効 (分解失敗)

**期待される動作:**
- `Venontjaraj` → `ven.ont.jar.aj` (✓有効)
- `venontjaran` → `ven.ont.jar.an` (✓有効)

### 根本原因

**構造の理解:**
```
venontjaraj
├─ venont (coming, 来たる) → ven + ont (動詞 + 未来能動分詞)
│  └─ 本来は venonta だが、縮約形として venont-
└─ jaraj (yearly, 年々の) → jar + aj (名詞語根 + 形容詞複数語尾)
```

**エスペラントの文法:**
- `venonta jara` (2語) = 来たる年の
- `venontjara` (1語、縮約形) = 同じ意味
- 縮約時、形容詞語尾 `-a` を省略して直接結合

**現在のアルゴリズムの問題:**

1. `venontjaraj` → 語尾 `aj` 除去 → `venontjar`
2. `venontjar` を分解:
   - `ven` (✓ 見つかる) + `ontjar` (続行)
3. `ontjar` を分解:
   - `ont` (✓ 分詞として見つかる) + `jar` (続行)
4. **問題発生:**
   - `ont` は分詞 (synthesis=Participle)
   - `ont` は `with_ending=No` (語尾を必要とする)
   - しかし次の `jar` は語根であり、語尾ではない
   - → 検証失敗

**アルゴリズムの制約:**
- 分詞は語尾と組み合わせることを期待
- 分詞 + 別の語根 という組み合わせを想定していない

### 修正方法

#### オプション1: 分詞の結合ルールを拡張 (推奨、難易度: 高)

**ファイル:** `literumilo/literumilo_scan_morphemes.py` (行546付近)

**修正の方向性:**
- `check_participle()` 関数を拡張
- 分詞の後に語根が来る場合を許可
- ただし、その語根が形容詞化可能であることを確認

**擬似コード:**
```python
def check_participle(index, morpheme_list):
    # 既存のチェック...

    # 新規: 次の形態素が語根の場合
    if index < last:
        next_entry = morpheme_list.get(index + 1)

        # 次が語根で、形容詞化可能な場合
        if next_entry.synthesis in [Synthesis.UnLimited, Synthesis.Limited]:
            if next_entry.with_ending == WithEnding.Yes:
                # 形容詞の縮約形として許可
                return True

    # 既存の処理...
```

**課題:**
- 複雑なケースを正しく処理する必要がある
- 誤判定のリスク

#### オプション2: 辞書に縮約形を追加 (簡易、推奨)

**ファイル:** `literumilo/data/vortaro.tsv`

```tsv
# 追加行
venontjar	ADJ	N	N	N	KF	NLM	3	K
```

**フィールド説明:**
- `venontjar`: 形態素
- `ADJ`: 形容詞
- `N`: 意味カテゴリなし
- `N`: 他動性なし
- `N`: 語尾なしでは使えない
- `KF`: 語尾ありで使える
- `NLM`: 無制限に結合可能
- `3`: 稀少度 (やや稀)
- `K`: 複合語フラグ

**利点:**
- 即座に動作
- コード変更不要

**欠点:**
- 同様のパターン（venontmonata, pasintjaraなど）も個別に追加が必要
- 辞書が肥大化

#### オプション3: 語根2つを辞書に追加 (最小限)

**ファイル:** `literumilo/data/vortaro.tsv`

```tsv
# 単に venont を語根として追加
venont	ADJ	N	N	N	KF	NLM	3	R
```

**理由:**
- `venont` を独立した形容詞語根として認識
- `ven.ont` ではなく `venont` として処理
- これにより `venont.jar.aj` が可能に

**利点:**
- シンプル
- 他の組み合わせ (venont + 他の語根) も自動対応

**欠点:**
- 本来の形態素分解 (`ven + ont`) が失われる

---

## Problem 6: Esperanto-Kongreso (大文字保持の問題)

### 問題の詳細

**現在の動作:**
- `Esperanto-Kongreso` → `Esperant.oK.on.gres.o` (⚠️ 不正確)

**期待される動作:**
- `Esperanto-Kongreso` → `Esperant.o.Kongres.o` (✓正確)

### 根本原因

**ファイル:** `literumilo/literumilo_utils.py` (行99-128)

```python
def restore_capitals(original, analyzed):
    """The Esperanto dictionary (vortaro) has only lower case morphemes, so words
    are converted to lower case for dictionary lookups. It might be useful to
    convert words back to their original case after analysis. For example, an
    analysis of the word  'RIĈULO' will produce 'riĉ.ul.o'. This function will take
    'RIĈULO' and 'riĉ.ul.o' to produce 'RIĈ.UL.O'.
    """
    result = ""
    index = 0
    original_length = len(original)

    for ch in analyzed:
        if ch == ".":
            result += "."
        else:
            if (index < original_length):
                result += original[index]  # ← 問題: ハイフンが考慮されていない
            else:
                result += ch
            index += 1
    return result
```

**問題点:**
- 元の単語 `Esperanto-Kongreso` にはハイフン `-` が含まれる
- しかし分析結果 `esperant.o.kongres.o` にはハイフンが含まれない
- `restore_capitals` は文字を1:1で対応させようとする
- ハイフンの存在により、インデックスがずれる

**具体例:**
```
Original:  E s p e r a n t o - K o n g r e s o
Index:     0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16
Analyzed:  e s p e r a n t . o . k o n g r e s . o
           ↑ ↑ ↑ ↑ ↑ ↑ ↑ ↑     ↑     ↑ ←インデックスずれ
```

### 修正方法

#### コード修正 (推奨)

**ファイル:** `literumilo/literumilo_utils.py` (行99-128)

**修正案:**

```python
def restore_capitals(original, analyzed):
    """Restore original capitalization, accounting for hyphens and special chars."""
    result = ""
    original_index = 0
    original_length = len(original)

    for ch in analyzed:
        if ch == ".":
            result += "."
        else:
            # Skip hyphens and other non-word characters in original
            while original_index < original_length:
                orig_ch = original[original_index]
                if not is_word_char(orig_ch):
                    original_index += 1
                    continue
                break

            # Restore capital
            if original_index < original_length:
                result += original[original_index]
                original_index += 1
            else:
                result += ch

    return result
```

**変更点:**
- 元の単語でハイフンなどの非単語文字をスキップ
- 単語文字のみをマッチング
- インデックスずれを防止

---

## 推奨される修正の優先順位

### 優先度: 高 (即座に修正すべき)

1. **Problem 2: konsentita の他動性修正**
   - **ファイル:** `literumilo/data/vortaro.tsv`
   - **変更:** `konsent` の他動性を `N` → `X` に変更
   - **影響:** 小
   - **難易度:** 低

2. **Problem 1: socialisto のコード修正**
   - **ファイル:** `literumilo/literumilo_suffix.py` (行396)
   - **変更:** `pos <= POS.Verb` → `pos <= POS.Adjective`
   - **影響:** 中 (他の `-ist` 接尾辞にも影響)
   - **難易度:** 低

### 優先度: 中 (検討すべき)

3. **Problem 6: Esperanto-Kongreso の大文字保持修正**
   - **ファイル:** `literumilo/literumilo_utils.py` (行99-128)
   - **変更:** `restore_capitals()` 関数を書き換え
   - **影響:** 小 (表示のみ、機能は変わらない)
   - **難易度:** 中

4. **Problem 3: venontjaraj の辞書追加**
   - **ファイル:** `literumilo/data/vortaro.tsv`
   - **変更:** `venont` を形容詞語根として追加
   - **影響:** 小
   - **難易度:** 低

### 優先度: 低 (将来的な拡張)

5. **Problem 3: venontjaraj のアルゴリズム拡張**
   - **ファイル:** `literumilo/literumilo_scan_morphemes.py`
   - **変更:** 分詞 + 語根 の組み合わせを許可
   - **影響:** 大 (多くの縮約形に対応)
   - **難易度:** 高

---

## 修正後のテスト計画

### テストケース

```python
test_cases = [
    # Problem 1
    ("socialisto", "social.ist.o", True),
    ("idealisto", "ideal.ist.o", True),
    ("materialisto", "material.ist.o", True),

    # Problem 2
    ("konsentita", "konsent.it.a", True),
    ("konsentite", "konsent.it.e", True),

    # Problem 4
    ("interkonsentite", "inter.konsent.it.e", True),

    # Problem 3 (辞書追加後)
    ("venontjara", "venont.jar.a", True),
    ("venontjaraj", "venont.jar.aj", True),
    ("venontjaran", "venont.jar.an", True),

    # Problem 6
    ("Esperanto-Kongreso", "Esperant.o.Kongres.o", True),

    # 既存機能の回帰テスト
    ("miskomprenita", "mis.kompren.it.a", True),
    ("ĉirkaŭiris", "ĉirkaŭ.ir.is", True),
    ("esperantisto", "esperant.ist.o", True),
]
```

---

## まとめ

### 発見された問題の分類

| 問題種類 | 件数 | 修正方法 |
|---------|------|----------|
| コード修正が必要 | 2件 | `literumilo_suffix.py`, `literumilo_utils.py` |
| 辞書データ修正が必要 | 1件 | `vortaro.tsv` (konsent の他動性) |
| 辞書追加が推奨 | 1件 | `vortaro.tsv` (venont の追加) |
| アルゴリズム拡張 (将来) | 1件 | `literumilo_scan_morphemes.py` |

### 推奨される修正順序

1. **辞書データ修正** (最優先): konsent の他動性を修正
2. **コード修正1**: check_ist を形容詞も許可するように修正
3. **辞書追加**: venont を形容詞語根として追加
4. **コード修正2**: restore_capitals のハイフン対応
5. **将来的拡張**: 分詞+語根の組み合わせアルゴリズム

すべての修正を適用することで、literumilo の語根分解精度が大幅に向上します。
